name: Update RCC Formula

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest RCC release
        id: get_release
        run: |
          # Get the latest release from GitHub API
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/joshyorko/rcc/releases/latest)
          VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name' | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest version: $VERSION"

      - name: Get current formula version
        id: current_version
        run: |
          CURRENT=$(grep -oP 'version "\K[^"]+' Formula/rcc.rb)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Download and calculate SHA256 hashes
        id: get_shas
        run: |
          VERSION="${{ steps.get_release.outputs.version }}"
          BASE_URL="https://github.com/joshyorko/rcc/releases/download/v${VERSION}"
          
          # Download Linux binary and get SHA256
          curl -sL "${BASE_URL}/rcc-linux64" -o /tmp/rcc-linux64
          LINUX_SHA=$(sha256sum /tmp/rcc-linux64 | awk '{print $1}')
          echo "linux_sha=$LINUX_SHA" >> $GITHUB_OUTPUT
          echo "Linux SHA256: $LINUX_SHA"
          
          # Download macOS binary and get SHA256
          curl -sL "${BASE_URL}/rcc-darwin64" -o /tmp/rcc-darwin64
          DARWIN_SHA=$(sha256sum /tmp/rcc-darwin64 | awk '{print $1}')
          echo "darwin_sha=$DARWIN_SHA" >> $GITHUB_OUTPUT
          echo "Darwin SHA256: $DARWIN_SHA"
          
          # Cleanup
          rm -f /tmp/rcc-linux64 /tmp/rcc-darwin64

      - name: Get current SHA256 hashes from formula
        id: current_shas
        run: |
          # Extract all sha256 values from formula
          LINUX_SHA=$(grep -A1 'on_linux' Formula/rcc.rb | grep -oP 'sha256 "\K[a-f0-9]+' | head -1)
          DARWIN_SHA=$(grep -A2 'on_macos' Formula/rcc.rb | grep -oP 'sha256 "\K[a-f0-9]+' | head -1)
          echo "linux_sha=$LINUX_SHA" >> $GITHUB_OUTPUT
          echo "darwin_sha=$DARWIN_SHA" >> $GITHUB_OUTPUT
          echo "Current Linux SHA256: $LINUX_SHA"
          echo "Current Darwin SHA256: $DARWIN_SHA"

      - name: Check if update needed
        id: check_update
        run: |
          NEEDS_UPDATE=false
          
          # Check version
          if [ "${{ steps.get_release.outputs.version }}" != "${{ steps.current_version.outputs.version }}" ]; then
            echo "Version changed: ${{ steps.current_version.outputs.version }} -> ${{ steps.get_release.outputs.version }}"
            NEEDS_UPDATE=true
          fi
          
          # Check Linux SHA256
          if [ "${{ steps.get_shas.outputs.linux_sha }}" != "${{ steps.current_shas.outputs.linux_sha }}" ]; then
            echo "Linux SHA256 changed"
            NEEDS_UPDATE=true
          fi
          
          # Check Darwin SHA256
          if [ "${{ steps.get_shas.outputs.darwin_sha }}" != "${{ steps.current_shas.outputs.darwin_sha }}" ]; then
            echo "Darwin SHA256 changed"
            NEEDS_UPDATE=true
          fi
          
          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          if [ "$NEEDS_UPDATE" = "false" ]; then
            echo "Already up to date"
          fi

      - name: Update formula
        if: steps.check_update.outputs.needs_update == 'true'
        env:
          VERSION: ${{ steps.get_release.outputs.version }}
          LINUX_SHA: ${{ steps.get_shas.outputs.linux_sha }}
          DARWIN_SHA: ${{ steps.get_shas.outputs.darwin_sha }}
        run: |
          cat > Formula/rcc.rb << EOF
          class Rcc < Formula
            desc "RCC - Repeatable Contained Code automation runtime with Linux support"
            homepage "https://github.com/joshyorko/rcc"
            version "${VERSION}"
            license "Apache-2.0"

            livecheck do
              url :stable
              regex(/^v?(\d+(?:\.\d+)+)\$/i)
            end

            on_linux do
              on_intel do
                url "https://github.com/joshyorko/rcc/releases/download/v#{version}/rcc-linux64"
                sha256 "${LINUX_SHA}"
              end
            end

            on_macos do
              on_intel do
                url "https://github.com/joshyorko/rcc/releases/download/v#{version}/rcc-darwin64"
                sha256 "${DARWIN_SHA}"
              end
              # Note: No ARM build available yet - darwin64 works via Rosetta 2
              on_arm do
                url "https://github.com/joshyorko/rcc/releases/download/v#{version}/rcc-darwin64"
                sha256 "${DARWIN_SHA}"
              end
            end

            def install
              if OS.linux?
                bin.install "rcc-linux64" => "rcc"
              else
                bin.install "rcc-darwin64" => "rcc"
              end
            end

            def caveats
              <<~EOS
                If 'rcc' is not found after installation, refresh your shell's cache:
                  hash -r

                Or start a new terminal session.
              EOS
            end

            test do
              assert_match version.to_s, shell_output("#{bin}/rcc version")
            end
          end
          EOF
          
          # Fix indentation (remove leading spaces from heredoc)
          sed -i 's/^          //' Formula/rcc.rb
          
          echo "Updated formula:"
          cat Formula/rcc.rb

      - name: Commit and push changes
        if: steps.check_update.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Formula/rcc.rb
          git commit -m "Update rcc to v${{ steps.get_release.outputs.version }}"
          git push
