name: Update RCC Cask

on:
  schedule:
    # Run daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-cask:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get latest RCC release
        id: get_release
        run: |
          # Get the latest release from GitHub API
          LATEST_RELEASE=$(curl -s https://api.github.com/repos/joshyorko/rcc/releases/latest)
          VERSION=$(echo "$LATEST_RELEASE" | jq -r '.tag_name' | sed 's/^v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Latest version: $VERSION"

      - name: Get current cask version
        id: current_version
        run: |
          CURRENT=$(grep -oP 'version "\K[^"]+' Casks/rcc.rb)
          echo "version=$CURRENT" >> $GITHUB_OUTPUT
          echo "Current version: $CURRENT"

      - name: Download and calculate SHA256 hashes
        id: get_shas
        run: |
          VERSION="${{ steps.get_release.outputs.version }}"
          BASE_URL="https://github.com/joshyorko/rcc/releases/download/v${VERSION}"
          
          # Download Linux binary and get SHA256
          curl -sL "${BASE_URL}/rcc-linux64" -o /tmp/rcc-linux64
          LINUX_SHA=$(sha256sum /tmp/rcc-linux64 | awk '{print $1}')
          echo "linux_sha=$LINUX_SHA" >> $GITHUB_OUTPUT
          echo "Linux SHA256: $LINUX_SHA"
          
          # Download macOS binary and get SHA256
          curl -sL "${BASE_URL}/rcc-darwin64" -o /tmp/rcc-darwin64
          DARWIN_SHA=$(sha256sum /tmp/rcc-darwin64 | awk '{print $1}')
          echo "darwin_sha=$DARWIN_SHA" >> $GITHUB_OUTPUT
          echo "Darwin SHA256: $DARWIN_SHA"
          
          # Cleanup
          rm -f /tmp/rcc-linux64 /tmp/rcc-darwin64

      - name: Get current SHA256 hashes from cask
        id: current_shas
        run: |
          # Extract sha256 values from cask
          LINUX_SHA=$(grep -oP 'x86_64_linux: "\K[a-f0-9]+' Casks/rcc.rb)
          DARWIN_SHA=$(grep -oP 'arm:\s+"\K[a-f0-9]+' Casks/rcc.rb)
          echo "linux_sha=$LINUX_SHA" >> $GITHUB_OUTPUT
          echo "darwin_sha=$DARWIN_SHA" >> $GITHUB_OUTPUT
          echo "Current Linux SHA256: $LINUX_SHA"
          echo "Current Darwin SHA256: $DARWIN_SHA"

      - name: Check if update needed
        id: check_update
        run: |
          NEEDS_UPDATE=false
          
          # Check version
          if [ "${{ steps.get_release.outputs.version }}" != "${{ steps.current_version.outputs.version }}" ]; then
            echo "Version changed: ${{ steps.current_version.outputs.version }} -> ${{ steps.get_release.outputs.version }}"
            NEEDS_UPDATE=true
          fi
          
          # Check Linux SHA256
          if [ "${{ steps.get_shas.outputs.linux_sha }}" != "${{ steps.current_shas.outputs.linux_sha }}" ]; then
            echo "Linux SHA256 changed"
            NEEDS_UPDATE=true
          fi
          
          # Check Darwin SHA256
          if [ "${{ steps.get_shas.outputs.darwin_sha }}" != "${{ steps.current_shas.outputs.darwin_sha }}" ]; then
            echo "Darwin SHA256 changed"
            NEEDS_UPDATE=true
          fi
          
          echo "needs_update=$NEEDS_UPDATE" >> $GITHUB_OUTPUT
          if [ "$NEEDS_UPDATE" = "false" ]; then
            echo "Already up to date"
          fi

      - name: Update cask
        if: steps.check_update.outputs.needs_update == 'true'
        env:
          VERSION: ${{ steps.get_release.outputs.version }}
          LINUX_SHA: ${{ steps.get_shas.outputs.linux_sha }}
          DARWIN_SHA: ${{ steps.get_shas.outputs.darwin_sha }}
        run: |
          cat > Casks/rcc.rb << 'EOF'
          cask "rcc" do
            arch arm: "darwin64", intel: "amd64"
            os macos: "darwin64", linux: "linux64"

            version "VERSION_PLACEHOLDER"
            sha256 arm:          "DARWIN_SHA_PLACEHOLDER",
                   intel:        "DARWIN_SHA_PLACEHOLDER",
                   x86_64_linux: "LINUX_SHA_PLACEHOLDER"

            url "https://github.com/joshyorko/rcc/releases/download/v#{version}/rcc-#{os}"
            name "RCC"
            desc "RCC - Repeatable Contained Code automation runtime"
            homepage "https://github.com/joshyorko/rcc"

            binary "rcc-#{os}", target: "rcc"

            caveats <<~EOS
              If 'rcc' is not found after installation, refresh your shell's cache:
                hash -r

              Or start a new terminal session.
            EOS
          end
          EOF
          
          # Fix indentation (remove leading spaces from heredoc)
          sed -i 's/^          //' Casks/rcc.rb
          
          # Replace placeholders with actual values
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/" Casks/rcc.rb
          sed -i "s/DARWIN_SHA_PLACEHOLDER/${DARWIN_SHA}/g" Casks/rcc.rb
          sed -i "s/LINUX_SHA_PLACEHOLDER/${LINUX_SHA}/" Casks/rcc.rb
          
          echo "Updated cask:"
          cat Casks/rcc.rb

      - name: Commit and push changes
        if: steps.check_update.outputs.needs_update == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add Casks/rcc.rb
          git commit -m "Update rcc cask to v${{ steps.get_release.outputs.version }}"
          git push
